<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blacklink Trust 1.2</title>
  <link rel="stylesheet" href="trust+nova.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <header>
    <div class="logo" style="display:flex;align-items:center;gap:10px;">
      <img src="trust-logo.svg" alt="Blacklink Trust logo" width="40" height="40" />
      <h3>Blacklink Trust</h3>
    </div>
    <div class="nav-right">
      <button id="theme-toggle" aria-pressed="false" aria-label="Toggle dark/light theme">🌙</button>
      <button id="account-btn">Login</button>
    </div>
  </header>

  <main class="container trust-extension">
    <h2>Sources</h2>
    <p>The source for finding sources.</p>

    <div class="toolbar">
      <input type="search" id="search-input" placeholder="Search sources…" disabled />
      <div class="filter-sort-row">
        <div class="filter-container" role="group" aria-label="Filter sources">
          <button data-filter="all" class="active" disabled>All</button>
          <button data-filter="trusted" disabled>Trusted</button>
          <button data-filter="mostly-trusted" disabled>Mostly Trusted</button>
          <button data-filter="not-trusted" disabled>Not Trusted</button>
        </div>
        <select id="sort-select" disabled>
          <option value="default">Sort By</option>
          <option value="name-asc">Name ↑</option>
          <option value="name-desc">Name ↓</option>
          <option value="category-asc">Category ↑</option>
          <option value="category-desc">Category ↓</option>
        </select>
      </div>
    </div>

    <div id="resource-list" style="min-height:150px;">
      <p id="loading-msg">Please log in to view sources.</p>
    </div>

    <div id="error-msg" style="color:red; margin-top:1rem;"></div>
  </main>

  <footer style="text-align:center;padding:2rem;color:#666;user-select:none;">
    © 2025 Blacklink Education, Inc. · Licensed under CC BY-NC-SA 4.0
  </footer>

  <script>
    // Firebase configuration
    firebase.initializeApp({
      apiKey: "AIzaSyDh1cCQXw1TGVJdVVgLEGdOgZlTPzGORLw",
      authDomain: "blacklink-auth.firebaseapp.com",
      projectId: "blacklink-auth",
      storageBucket: "blacklink-auth.appspot.com",
      messagingSenderId: "457832218084",
      appId: "1:457832218084:web:your-app-id-here"
    });

    const auth = firebase.auth();
    const accountBtn = document.getElementById("account-btn");
    const searchInput = document.getElementById("search-input");
    const filterButtons = document.querySelectorAll(".filter-container button");
    const sortSelect = document.getElementById("sort-select");
    const resourceList = document.getElementById("resource-list");
    const errorMsg = document.getElementById("error-msg");

    function displayFirebaseError(err) {
      if (err.code === "auth/invalid-email" || err.code === "auth/wrong-password") {
        errorMsg.textContent = "Invalid email or password.";
      } else if (err.code === "auth/user-not-found") {
        errorMsg.textContent = "User not found.";
      } else {
        errorMsg.textContent = err.message;
      }
    }

    function login() {
      const email = prompt("Email:");
      const password = prompt("Password:");
      auth.signInWithEmailAndPassword(email, password)
          .catch(displayFirebaseError);
    }

    function logout() {
      auth.signOut();
    }

    function updateAccountUI(user) {
      errorMsg.textContent = "";
      if (user) {
        accountBtn.textContent = `Logout (${user.email})`;
        accountBtn.onclick = logout;
        searchInput.disabled = false;
        filterButtons.forEach(b => b.disabled = false);
        sortSelect.disabled = false;
      } else {
        accountBtn.textContent = "Login";
        accountBtn.onclick = login;
        searchInput.disabled = true;
        filterButtons.forEach(b => b.disabled = true);
        sortSelect.disabled = true;
        resourceList.innerHTML = '<p id="loading-msg">Please log in to view sources.</p>';
      }
    }

    function createSourceElement(src) {
      const div = document.createElement("div");
      div.className = "resource-item";
      div.dataset.trust = src.details.trust || "not-trusted";
      div.dataset.name = src.name;
      div.dataset.category = src.details.category;
      div.setAttribute("tabindex", "0");
      div.setAttribute("role", "button");
      div.setAttribute("aria-expanded", "false");

      div.innerHTML = `
        <div class="top-row">
          <div class="name">
            <img src="${src.details.logo.src}" alt="${src.details.logo.alt}" class="source-logo"/>
            <strong>${src.name}</strong>
            <span class="source-tag">${src.details.category}</span>
          </div>
          <div class="right-controls">
            <a href="${src.details.visitUrl}" target="_blank"><button>Visit</button></a>
            <a href="${src.details.detailsPage}" target="_blank"><button>Expand</button></a>
            <button class="copy-link-btn">📋</button>
            <div class="trust-circle"></div>
          </div>
        </div>
        <div class="details"><p>${src.details.description}</p></div>
      `.trim();

      div.querySelector(".copy-link-btn").addEventListener("click", e => {
        e.stopPropagation();
        navigator.clipboard.writeText(src.details.visitUrl).then(() => {
          e.target.textContent = "✅";
          setTimeout(() => e.target.textContent = "📋", 1500);
        });
      });

      div.addEventListener("click", () => {
        const det = div.querySelector(".details");
        const expanded = !div.classList.contains("expanded");
        div.classList.toggle("expanded", expanded);
        div.setAttribute("aria-expanded", expanded);
        det.style.maxHeight = expanded ? det.scrollHeight + "px" : "0";
      });

      return div;
    }

    async function loadSources() {
      resourceList.innerHTML = `<p id="loading-msg">Loading sources…</p>`;
      try {
        const res = await fetch("https://trust.blacklink.net/sources/data.json");
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();
        resourceList.innerHTML = "";
        data.forEach(src => resourceList.appendChild(createSourceElement(src)));
        attachFilters();
      } catch (err) {
        resourceList.innerHTML = `<p style="color:red;">Failed to load sources: ${err.message}</p>`;
      }
    }

    function attachFilters() {
      filterButtons.forEach(btn => {
        btn.onclick = () => {
          filterButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          resourceList.querySelectorAll(".resource-item").forEach(item => {
            item.style.display = (btn.dataset.filter === "all" || item.dataset.trust === btn.dataset.filter)
              ? "flex" : "none";
          });
        };
      });
      searchInput.oninput = () => {
        const q = searchInput.value.toLowerCase();
        resourceList.querySelectorAll(".resource-item").forEach(item => {
          item.style.display = item.dataset.name.toLowerCase().includes(q) ? "flex" : "none";
        });
      };
      sortSelect.onchange = () => {
        const items = Array.from(resourceList.querySelectorAll(".resource-item"));
        const order = sortSelect.value;
        items.sort((a, b) => {
          if (order === "name-asc") return a.dataset.name.localeCompare(b.dataset.name);
          if (order === "name-desc") return b.dataset.name.localeCompare(a.dataset.name);
          if (order === "category-asc") return a.dataset.category.localeCompare(b.dataset.category);
          if (order === "category-desc") return b.dataset.category.localeCompare(a.dataset.category);
          return 0;
        });
        items.forEach(item => resourceList.appendChild(item));
      };
    }

    auth.onAuthStateChanged(user => {
      updateAccountUI(user);
      if (user) loadSources();
    });

    document.getElementById("theme-toggle").onclick = () => {
      const light = document.body.classList.toggle("light");
      document.getElementById("theme-toggle").textContent = light ? "🌞" : "🌙";
    };
resourceList.innerHTML = `<p id="loading-msg">Loading sources… ⏳</p>`;
    updateAccountUI(null);
  </script>
</body>
</html>