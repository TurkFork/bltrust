<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blacklink Trust 1.2</title>
  <link rel="stylesheet" href="trust+nova.css" />
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <header>
    <div class="logo" style="display:flex;align-items:center;gap:10px;">
      <img src="trust-logo.svg" alt="Blacklink Trust logo" width="40" height="40" />
      <h3>Blacklink Trust</h3>
    </div>
    <div class="nav-right">
      <button id="theme-toggle" aria-pressed="false" aria-label="Toggle dark or light theme">🌙</button>
      <button id="account-btn" disabled>Loading...</button>
    </div>
  </header>

  <main class="container trust-extension" style="position:relative;">
    <h2>Sources</h2>
    <p>The source for finding sources.</p>

    <div class="toolbar" style="position:relative;">
      <input type="search" id="search-input" placeholder="Search sources…" disabled autocomplete="off"
        aria-autocomplete="list" aria-controls="autocomplete-list" aria-expanded="false" />
      <div id="autocomplete-list" role="listbox" style="display:none;"></div>

      <div class="filter-sort-row" style="align-items:center;">
        <div class="filter-container" role="group" aria-label="Filter sources">
          <button data-filter="all" class="active" disabled title="Show all sources">All</button>
          <button data-filter="trusted" disabled title="Show only trusted sources">Trusted</button>
          <button data-filter="mostly-trusted" disabled title="Show mostly trusted sources">Mostly Trusted</button>
          <button data-filter="not-trusted" disabled title="Show not trusted sources">Not Trusted</button>
        </div>
        <select id="sort-select" disabled aria-label="Sort sources">
          <option value="default">Sort By</option>
          <option value="name-asc">Name ↑</option>
          <option value="name-desc">Name ↓</option>
          <option value="category-asc">Category ↑</option>
          <option value="category-desc">Category ↓</option>
        </select>
        <select id="category-filter" disabled aria-label="Filter by category" style="margin-left:10px;">
          <option value="all">All Categories</option>
        </select>
        <button id="clear-filters" title="Clear all filters and search" disabled>Clear Filters</button>
      </div>

      <div id="source-count" aria-live="polite" aria-atomic="true">Showing 0 sources</div>
    </div>

    <div id="resource-list" style="min-height:150px; display:flex; flex-direction:column; gap:15px;">
      <p id="loading-msg">Please log in to view sources.</p>
    </div>

    <div id="error-msg" style="color:red; margin-top:1rem;"></div>
  </main>

  <footer style="text-align:center; padding:2rem; color:#666; user-select:none;">
    © 2025 Blacklink Education, Inc. · Licensed under CC BY‑NC‑SA 4.0
  </footer>

  <script>
    // Firebase initialization
    firebase.initializeApp({
      apiKey: "AIzaSyDh1cCQXw1TGVJdVVgLEGdOgZlTPzGORLw",
      authDomain: "blacklink-auth.firebaseapp.com",
      projectId: "blacklink-auth",
      storageBucket: "blacklink-auth.appspot.com",
      messagingSenderId: "457832218084",
      appId: "1:457832218084:web:your-app-id-here"
    });

    const auth = firebase.auth();
    const accountBtn = document.getElementById("account-btn");
    const searchInput = document.getElementById("search-input");
    const filterButtons = document.querySelectorAll(".filter-container button");
    const sortSelect = document.getElementById("sort-select");
    const categoryFilter = document.getElementById("category-filter");
    const clearFiltersBtn = document.getElementById("clear-filters");
    const resourceList = document.getElementById("resource-list");
    const errorMsg = document.getElementById("error-msg");
    const sourceCount = document.getElementById("source-count");
    let allSources = [], expandedData = {}, filteredSources = [];

    // Utility: Show Firebase error nicely
    function displayFirebaseError(err) {
      if (["auth/invalid-email", "auth/wrong-password"].includes(err.code)) {
        errorMsg.textContent = "Invalid email or password.";
      } else if (err.code === "auth/user-not-found") {
        errorMsg.textContent = "User not found.";
      } else {
        errorMsg.textContent = err.message;
      }
    }

    // Disable or enable UI elements based on login
    function updateAccountUI(user) {
      errorMsg.textContent = "";
      const disabled = !user;
      accountBtn.textContent = user ? `Logout (${user.email})` : "Login";
      accountBtn.disabled = false;

      accountBtn.onclick = user
        ? logout
        : () => { window.location.href = "https://accounts.blacklink.net/public/login"; };

      [searchInput, ...filterButtons, sortSelect, categoryFilter, clearFiltersBtn]
        .forEach(el => el.disabled = disabled);

      resourceList.innerHTML = user
        ? ""
        : '<p id="loading-msg">Please log in to view sources.</p>';
      sourceCount.textContent = user ? `Showing 0 sources` : `Showing 0 sources`;
    }

    // Copy-paste your existing createSourceElement, applyFiltersAndSort, populateCategories, etc here
    // For brevity, I'll omit repeating those functions. (Use your existing code for those)

    // But include a minimal example for loadSources and loadExpandedData:
    async function loadExpandedData() {
      try {
        const res = await fetch("/sources/expanded.json");
        if (!res.ok) throw new Error(`Error ${res.status}`);
        const data = await res.json();
        expandedData = data.reduce((acc, item) => {
          if (item.name) acc[item.name] = item;
          return acc;
        }, {});
      } catch (err) {
        console.warn("Failed to load expanded data:", err);
        expandedData = {};
      }
    }

    async function loadSources() {
      try {
        const res = await fetch("/sources/data.json");
        if (!res.ok) throw new Error(`Error ${res.status}`);
        allSources = await res.json();
        await loadExpandedData();
        populateCategories();
        applyFiltersAndSort();
      } catch (err) {
        errorMsg.textContent = "Error loading sources.";
      }
    }

    function logout() {
      auth.signOut();
    }

    // On page load: check for JWT token (in URL param or localStorage)
    async function initAuth() {
      let token = null;

      // Check URL param "token" (example: https://site.com?token=XYZ)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has("token")) {
        token = urlParams.get("token");
        // Optionally save to localStorage for persistence
        localStorage.setItem("blacklinkJwtToken", token);
        // Remove token from URL to clean it up (optional)
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        // Else check localStorage
        token = localStorage.getItem("blacklinkJwtToken");
      }

      if (token) {
        try {
          await auth.signInWithCustomToken(token);
          // Signed in successfully, UI will update in onAuthStateChanged
        } catch (err) {
          console.error("Invalid token or sign-in failed:", err);
          localStorage.removeItem("blacklinkJwtToken");
          updateAccountUI(null);
        }
      } else {
        updateAccountUI(null);
      }
    }

    // Theme toggle
    document.getElementById("theme-toggle").addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      document.getElementById("theme-toggle").textContent =
        document.documentElement.classList.contains("dark") ? "☀️" : "🌙";
    });

    // Firebase auth state listener
    auth.onAuthStateChanged(user => {
      updateAccountUI(user);
      if (user) loadSources();
    });

    window.onload = () => {
      initAuth();
    };

  </script>
</body>

</html>